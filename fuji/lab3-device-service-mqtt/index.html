



<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="kurokobo">
      
      
        <meta name="lang:clipboard.copy" content="クリップボードへコピー">
      
        <meta name="lang:clipboard.copied" content="コピーしました">
      
        <meta name="lang:search.language" content="en, ja">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="何も見つかりませんでした">
      
        <meta name="lang:search.result.one" content="1件見つかりました">
      
        <meta name="lang:search.result.other" content="#件見つかりました">
      
        <meta name="lang:search.tokenizer" content="[\s\-　、。，．]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Lab 3 - デバイスサービスの追加（MQTT） - EdgeX Foundry ハンズオンラボ</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#757575">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="grey" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#lab-3-mqtt" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="EdgeX Foundry ハンズオンラボ" aria-label="EdgeX Foundry ハンズオンラボ" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              EdgeX Foundry ハンズオンラボ
            </span>
            <span class="md-header-nav__topic">
              
                Lab 3 - デバイスサービスの追加（MQTT）
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            検索キーワードを入力してください
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/kurokobo/edgex-hol-guide/" title="リポジトリへ" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="EdgeX Foundry ハンズオンラボ" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    EdgeX Foundry ハンズオンラボ
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/kurokobo/edgex-hol-guide/" title="リポジトリへ" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="このガイドについて" class="md-nav__link">
      このガイドについて
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Fuji リリース向けガイド
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Fuji リリース向けガイド
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Lab 0 - はじめに" class="md-nav__link">
      Lab 0 - はじめに
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab1-overview/" title="Lab 1 - 概要" class="md-nav__link">
      Lab 1 - 概要
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab2-gettingstarted/" title="Lab 2 - 導入とデータの確認" class="md-nav__link">
      Lab 2 - 導入とデータの確認
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Lab 3 - デバイスサービスの追加（MQTT）
      </label>
    
    <a href="./" title="Lab 3 - デバイスサービスの追加（MQTT）" class="md-nav__link md-nav__link--active">
      Lab 3 - デバイスサービスの追加（MQTT）
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目次</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    必要なファイルの用意
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    新しいデバイスの仕様と動作確認
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    新しいデバイスの仕様
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    シミュレータの起動
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    シミュレータの動作確認
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    デバイスサービスの構成
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    デバイスサービスの概念
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    デバイスサービスの構成要素
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    デバイスプロファイル
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    デバイスサービス設定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edgex-foundry" class="md-nav__link">
    デバイスサービスを含んだ EdgeX Foundry の起動
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    動作確認
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    登録状態の確認
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    デバイスから配信されている値の収集の確認
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    デバイスサービスの自動実行イベントの確認
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    デバイスへのコマンド実行の確認
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    まとめ
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab4-appservice-export-mqtt/" title="Lab 4 - データのエクスポート（MQTT）" class="md-nav__link">
      Lab 4 - データのエクスポート（MQTT）
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../lab5-rulesengine/" title="Lab 5 - ルールエンジンの利用" class="md-nav__link">
      Lab 5 - ルールエンジンの利用
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Geneva リリース向けガイド
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Geneva リリース向けガイド
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../geneva/" title="N/A" class="md-nav__link">
      N/A
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目次</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    必要なファイルの用意
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    新しいデバイスの仕様と動作確認
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    新しいデバイスの仕様
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    シミュレータの起動
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    シミュレータの動作確認
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    デバイスサービスの構成
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    デバイスサービスの概念
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    デバイスサービスの構成要素
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    デバイスプロファイル
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    デバイスサービス設定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edgex-foundry" class="md-nav__link">
    デバイスサービスを含んだ EdgeX Foundry の起動
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    動作確認
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    登録状態の確認
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    デバイスから配信されている値の収集の確認
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    デバイスサービスの自動実行イベントの確認
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    デバイスへのコマンド実行の確認
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    まとめ
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/kurokobo/edgex-hol-guide/edit/master/docs/fuji/lab3-device-service-mqtt.md" title="編集" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="lab-3-mqtt">Lab 3 - デバイスサービスの追加（MQTT）<a class="headerlink" href="#lab-3-mqtt" title="Permanent link">&para;</a></h1>
<p>前のラボで利用した仮想デバイスは、デバイスからのデータの受け取りやデバイスへのコマンド実行などをテストする目的ではたいへん便利ですが、現実世界とのインタラクションはできません。</p>
<p>そこで今回は、MQTT をインタフェイスにもつデバイス（のシミュレータ）を用意し、下図のように EdgeX Foundry がそのデバイスと実際に（MQTT ブローカを介して）インタラクションできる状態を構成します。</p>
<p><img alt="" src="../img/device-service-mqtt-architecture.png" /></p>
<h2 id="_1">必要なファイルの用意<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>前のラボでリポジトリをクローンしていない場合はクローンします。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>git clone https://github.com/kurokobo/edgex-lab-handson.git
</code></pre></div>
</td></tr></table>

<p>このラボでは、<code>lab03</code> ディレクトリの中身を利用します。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="nb">cd</span> lab03
</code></pre></div>
</td></tr></table>

<h2 id="_2">新しいデバイスの仕様と動作確認<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>まずは、今回新しく EdgeX Foundry の制御下におきたいデバイスの仕様を整理します。その後、実際にそのデバイスのシミュレータを動作させ、仕様通りに動くことを確認します。</p>
<h3 id="_3">新しいデバイスの仕様<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>今回は、以下のような仕様のデバイスを考えます。</p>
<ul>
<li>二種類のセンサを持つ<ul>
<li><code>randfloat32</code></li>
<li><code>randfloat64</code></li>
</ul>
</li>
<li>二種類の文字列情報を持つ<ul>
<li><code>ping</code></li>
<li><code>message</code></li>
</ul>
</li>
<li>トピック <code>DataTopic</code> にセンサ <code>randfloat32</code> の値を 15 秒ごとに配信する<ul>
<li><code>{"name":"MQ_DEVICE","cmd":"randfloat32","randfloat32":"&lt;値&gt;"}</code> の形式で配信する</li>
</ul>
</li>
<li>トピック <code>CommandTopic</code> でコマンドを待ち受ける<ul>
<li><code>{"name":"MQTT_DEVICE","method":"&lt;get または set&gt;","cmd":"&lt;コマンド名&gt;"}</code> の形式のコマンドを受け取る</li>
</ul>
</li>
<li>コマンドを受け取ったら、コマンド応じて処理を実行し、結果をトピック <code>ResponseTopic</code> に配信する<ul>
<li>コマンドのメソッドが <code>set</code> だった場合は、保存されている <code>message</code> を書き換える</li>
<li>コマンドが <code>ping</code> だった場合は、<code>pong</code> を返す</li>
<li>コマンドが <code>message</code> だった場合は、保存されている <code>message</code> を返す</li>
<li>コマンドが <code>randfloat32</code> または <code>randfloat64</code> だった場合は、それぞれ対応するセンサの値を返す</li>
<li>結果は <code>{"name":"MQ_DEVICE","method":"&lt;メソッド&gt;","cmd":"&lt;コマンド名&gt;","&lt;コマンド名&gt;":"&lt;値&gt;"}</code> の形式で配信する</li>
</ul>
</li>
</ul>
<p>デバイス側が定期的にデータを発信するだけでなく、コマンド操作も受け付けるようなデバイスです。ただしよく見ると、二つあるセンサのうち <code>randfloat64</code> は、値の定期的な自動配信はありません（これは伏線です）。</p>
<h3 id="_4">シミュレータの起動<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>今回は、上記のようなデバイスを模したシミュレータを利用します。MQTT を扱うにはブローカが不可欠なので、まずはこれを起動します。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ docker run -d --rm --name broker -p <span class="m">1883</span>:1883 eclipse-mosquitto
6de5986ebb1b3715179253857952f143fbf19fa77e201980f8573d96558850fd
</code></pre></div>
</td></tr></table>

<p>続けてデバイス（のシミュレータ）の用意です。</p>
<p>Node.js で MQTT を扱えるコンテナ <code>dersimn/mqtt-scripts</code> で、次のようなスクリプトを起動させます。このスクリプトは <code>mqtt-scripts</code> ディレクトリ内に保存されています。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">getRandomFloat</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span><span class="p">)</span> <span class="o">+</span> <span class="nx">min</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">deviceName</span> <span class="o">=</span> <span class="s2">&quot;MQ_DEVICE&quot;</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;test-message&quot;</span><span class="p">;</span>

<span class="c1">// 1. Publish random number every 15 seconds</span>
<span class="nx">schedule</span><span class="p">(</span><span class="s1">&#39;*/15 * * * * *&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">body</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="nx">deviceName</span><span class="p">,</span>
        <span class="s2">&quot;cmd&quot;</span><span class="o">:</span> <span class="s2">&quot;randfloat32&quot;</span><span class="p">,</span>
        <span class="s2">&quot;randfloat32&quot;</span><span class="o">:</span> <span class="nx">getRandomFloat</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">29</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">};</span>
    <span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;DataTopic&#39;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
<span class="p">});</span>

<span class="c1">// 2. Receive the reading request, then return the response</span>
<span class="c1">// 3. Receive the put request, then change the device value</span>
<span class="nx">subscribe</span><span class="p">(</span><span class="s2">&quot;CommandTopic&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">topic</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s2">&quot;set&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">cmd</span><span class="p">]</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">cmd</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s2">&quot;ping&quot;</span><span class="o">:</span>
                <span class="nx">data</span><span class="p">.</span><span class="nx">ping</span> <span class="o">=</span> <span class="s2">&quot;pong&quot;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s2">&quot;message&quot;</span><span class="o">:</span>
                <span class="nx">data</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s2">&quot;randfloat32&quot;</span><span class="o">:</span>
                <span class="nx">data</span><span class="p">.</span><span class="nx">randfloat32</span> <span class="o">=</span> <span class="nx">getRandomFloat</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">29</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s2">&quot;randfloat64&quot;</span><span class="o">:</span>
                <span class="nx">data</span><span class="p">.</span><span class="nx">randfloat64</span> <span class="o">=</span> <span class="nx">getRandomFloat</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">publish</span><span class="p">(</span><span class="s2">&quot;ResponseTopic&quot;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>

<p>これを起動するには、以下のように作業します。IP アドレスは適宜読み替えてください。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ <span class="nb">cd</span> mqtt-scripts
$ docker run -d --restart<span class="o">=</span>always --name<span class="o">=</span>mqtt-scripts -v <span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">:/scripts&quot;</span> dersimn/mqtt-scripts --url mqtt://&lt;IP アドレス&gt; --dir /scripts
Unable to find image <span class="s1">&#39;dersimn/mqtt-scripts:latest&#39;</span> locally
...
9d52b4956ebbec60dd0f93bdf9750ff915fefd8e8c58d3ce8bc7ba1429693d2b
</code></pre></div>
</td></tr></table>

<h3 id="_5">シミュレータの動作確認<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>ブローカの全トピックを購読します。15 秒ごとに <code>DataTopic</code> にセンサ <code>randfloat32</code> の値が届いていることがわかります。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ docker run --init --rm -it efrecon/mqtt-client sub -h <span class="m">192</span>.168.0.100 -t <span class="s2">&quot;#&quot;</span> -v
...
DataTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQ_DEVICE&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;randfloat32&quot;</span>,<span class="s2">&quot;randfloat32&quot;</span>:<span class="s2">&quot;27.4&quot;</span><span class="o">}</span>
DataTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQ_DEVICE&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;randfloat32&quot;</span>,<span class="s2">&quot;randfloat32&quot;</span>:<span class="s2">&quot;28.6&quot;</span><span class="o">}</span>
</code></pre></div>
</td></tr></table>

<p>コマンド操作ができることも確認します。別のターミナルで <code>CommandTopic</code> にコマンドを配信します。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ docker run --init -it --rm efrecon/mqtt-client pub -h <span class="m">192</span>.168.0.100 -t <span class="s2">&quot;CommandTopic&quot;</span> -m <span class="s1">&#39;{&quot;name&quot;:&quot;MQTT_DEVICE&quot;,&quot;method&quot;:&quot;get&quot;,&quot;cmd&quot;:&quot;ping&quot;}&#39;</span>

$ docker run --init -it --rm efrecon/mqtt-client pub -h <span class="m">192</span>.168.0.100 -t <span class="s2">&quot;CommandTopic&quot;</span> -m <span class="s1">&#39;{&quot;name&quot;:&quot;MQTT_DEVICE&quot;,&quot;method&quot;:&quot;get&quot;,&quot;cmd&quot;:&quot;randfloat32&quot;}&#39;</span>

$ docker run --init -it --rm efrecon/mqtt-client pub -h <span class="m">192</span>.168.0.100 -t <span class="s2">&quot;CommandTopic&quot;</span> -m <span class="s1">&#39;{&quot;name&quot;:&quot;MQTT_DEVICE&quot;,&quot;method&quot;:&quot;get&quot;,&quot;cmd&quot;:&quot;randfloat64&quot;}&#39;</span>

$ docker run --init -it --rm efrecon/mqtt-client pub -h <span class="m">192</span>.168.0.100 -t <span class="s2">&quot;CommandTopic&quot;</span> -m <span class="s1">&#39;{&quot;name&quot;:&quot;MQTT_DEVICE&quot;,&quot;method&quot;:&quot;get&quot;,&quot;cmd&quot;:&quot;message&quot;}&#39;</span>

$ docker run --init -it --rm efrecon/mqtt-client pub -h <span class="m">192</span>.168.0.100 -t <span class="s2">&quot;CommandTopic&quot;</span> -m <span class="s1">&#39;{&quot;name&quot;:&quot;MQTT_DEVICE&quot;,&quot;method&quot;:&quot;set&quot;,&quot;cmd&quot;:&quot;message&quot;,&quot;message&quot;:&quot;modified-message&quot;}&#39;</span>

$ docker run --init -it --rm efrecon/mqtt-client pub -h <span class="m">192</span>.168.0.100 -t <span class="s2">&quot;CommandTopic&quot;</span> -m <span class="s1">&#39;{&quot;name&quot;:&quot;MQTT_DEVICE&quot;,&quot;method&quot;:&quot;get&quot;,&quot;cmd&quot;:&quot;message&quot;}&#39;</span>
</code></pre></div>
</td></tr></table>

<p>購読している側では、コマンドが <code>CommandTopic</code> に届き、そのコマンドに応じた応答が <code>ResponseTopic</code> に配信されていることが確認できます。また、<code>message</code> コマンドの結果が、<code>set</code> メソッドの実行前後で変更されていることも確認できます。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ docker run --init --rm -it efrecon/mqtt-client sub -h <span class="m">192</span>.168.0.100 -t <span class="s2">&quot;#&quot;</span> -v
...
CommandTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;ping&quot;</span><span class="o">}</span>
ResponseTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;ping&quot;</span>,<span class="s2">&quot;ping&quot;</span>:<span class="s2">&quot;pong&quot;</span><span class="o">}</span>
...
CommandTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;randfloat32&quot;</span><span class="o">}</span>
ResponseTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;randfloat32&quot;</span>,<span class="s2">&quot;randfloat32&quot;</span>:<span class="s2">&quot;27.6&quot;</span><span class="o">}</span>
...
CommandTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;randfloat64&quot;</span><span class="o">}</span>
ResponseTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;randfloat64&quot;</span>,<span class="s2">&quot;randfloat64&quot;</span>:<span class="s2">&quot;8.39883&quot;</span><span class="o">}</span>
...
CommandTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;message&quot;</span><span class="o">}</span>
ResponseTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;message&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;test-message&quot;</span><span class="o">}</span>
...
CommandTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;set&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;message&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;modified-message&quot;</span><span class="o">}</span>
ResponseTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;set&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;message&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;modified-message&quot;</span><span class="o">}</span>
...
CommandTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;message&quot;</span><span class="o">}</span>
ResponseTopic <span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;MQTT_DEVICE&quot;</span>,<span class="s2">&quot;method&quot;</span>:<span class="s2">&quot;get&quot;</span>,<span class="s2">&quot;cmd&quot;</span>:<span class="s2">&quot;message&quot;</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;modified-message&quot;</span><span class="o">}</span>
</code></pre></div>
</td></tr></table>

<p>ここまでで、デバイス（のシミュレータ）が動作している状態が作れました。ここまでは EdgeX Foundry はまったく関係なく、ただ単に前述の仕様のデバイスを論理的に作っただけです。</p>
<h2 id="_6">デバイスサービスの構成<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>さて、ここからが本題です。先ほど作ったデバイスを EdgeX Foundry の制御下におくことを考えます。</p>
<h3 id="_7">デバイスサービスの概念<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>現実世界に存在するデバイスは、それぞれが異なるセンサやスイッチを持っていて、異なるプロトコルをインタフェイスに持つため、それぞれに応じた適切な方法で値の取得や制御命令の発行をする必要があります。</p>
<p>この実態を踏まえ、EdgeX Foundry では、実デバイスと EdgeX Foundry の間を取り持ってくれる存在としてデバイスサービスとよばれるマイクロサービスを定義しています。デバイスサービスは、おおむねデバイスの種類ごとに用意するものと思えばよさそうで、つまり、ひとつのデバイスサービスに対してひとつ以上のデバイスの制御を任せられるようです。</p>
<p>デバイスサービスは、以下のような役割を持ちます。</p>
<ul>
<li>コアサービス層に対して、デバイスからの情報取得やデバイスへの制御命令の発行を行える REST エンドポイントを提供する</li>
<li>コアサービス層からの制御命令を実デバイスに合わせた命令に翻訳して実行し、実デバイスを制御する</li>
<li>デバイスから送られてきた情報をコアサービス層に合わせた情報に翻訳し、コアサービス層に届ける</li>
<li>事前に定められた場合は、定期的にデバイスに対して特定の処理を行い、結果をコアサービス層に届ける</li>
</ul>
<p>また、デバイスサービスそのものは、以下のような特徴を持ちます。</p>
<ul>
<li>MQTT や Modbus など業界で多く使われるプロトコルに合わせたデバイスサービスはすでに参考実装が用意されており、複雑でない構成の場合は充分に流用できる</li>
<li>参考実装の流用では不足する場合は、提供されている SDK を利用して気軽に自製できる（C 言語または Go 言語）</li>
<li>すべてのデバイスサービスはこの SDK を用いて共通のフレームワークのもとで実装されるため、操作方法や設定方法は自ずと共通化され、相互運用性は高まる</li>
<li>EdgeX Foundry を取り巻くエコシステムの成熟により、デバイスのベンダがそのデバイス用のデバイスサービスを提供したり、デバイスにデバイスサービスが組み込まれたり、第三者により開発されたデバイスサービスの充実も期待できる</li>
<li>EdgeX Foundry に限った話ではないですが、プラットフォーム系の製品の場合、製品の発展にはエコシステムの成熟が非常に重要です。この観点では、EdgeX Foundry は、商用環境への利用を謳ったバージョン 1.0 のリリースが 2019 年の冬とついこの前なので、まだまだこれからですね。</li>
</ul>
<h3 id="_8">デバイスサービスの構成要素<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>デバイスを制御するデバイスサービスを追加するには、以下の 3 つの要素を考える必要があります。</p>
<ul>
<li>デバイスサービスそのもの<ul>
<li>コアサービスとデバイスとの間を仲介する、C 言語または Go 言語で実装されたマイクロサービス</li>
<li>今回はコンテナとして動作させる</li>
<li>後述のデバイスプロファイルとデバイスサービス設定を読み込んで動作する</li>
</ul>
</li>
<li>デバイスプロファイル（Device Profile）<ul>
<li>YAML ファイルとして定義</li>
<li>管理対象のデバイス種別が持つリソースや、そのリソースが持つ値の意味、それぞれのリソースに対して行える操作などを定義する</li>
</ul>
</li>
<li>デバイスサービス設定（Drvice Service Configuration）<ul>
<li><code>configuration.toml</code> ファイルとして定義</li>
<li>デバイスサービス自身の設定や、連携する EdgeX Foundry の他のマイクロサービスの情報などを定義する</li>
<li>デバイスプロファイルと実際のデバイスを紐づけてデバイスを定義する。デバイスやリソースに対する自動実行処理なども定義する</li>
<li>その他、デバイスサービスの動作に必要なパラメータを指定する</li>
</ul>
</li>
</ul>
<h3 id="_9">デバイスプロファイル<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>今回は、<code>mqtt</code> ディレクトリ内の <code>mqtt.test.device.profile.yml</code> を利用します。中身は以下の通りです。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="s">&quot;Test.Device.MQTT.Profile&quot;</span>
<span class="nt">manufacturer</span><span class="p">:</span> <span class="s">&quot;Dell&quot;</span>
<span class="nt">model</span><span class="p">:</span> <span class="s">&quot;MQTT-2&quot;</span>
<span class="nt">labels</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="s">&quot;test&quot;</span>
<span class="nt">description</span><span class="p">:</span> <span class="s">&quot;Test</span><span class="nv"> </span><span class="s">device</span><span class="nv"> </span><span class="s">profile&quot;</span>

<span class="nt">deviceResources</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">randfloat32</span>
  <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;device</span><span class="nv"> </span><span class="s">random</span><span class="nv"> </span><span class="s">number</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">Base64</span><span class="nv"> </span><span class="s">encoding&quot;</span>
  <span class="nt">properties</span><span class="p">:</span>
    <span class="nt">value</span><span class="p">:</span>
      <span class="p p-Indicator">{</span><span class="nt"> type</span><span class="p">:</span> <span class="s">&quot;Float32&quot;</span><span class="p p-Indicator">,</span><span class="nt"> size</span><span class="p">:</span> <span class="s">&quot;4&quot;</span><span class="p p-Indicator">,</span><span class="nt"> readWrite</span><span class="p">:</span> <span class="s">&quot;R&quot;</span><span class="p p-Indicator">,</span><span class="nt"> defaultValue</span><span class="p">:</span> <span class="s">&quot;0.00&quot;</span><span class="p p-Indicator">,</span><span class="nt"> minimum</span><span class="p">:</span> <span class="s">&quot;100.00&quot;</span><span class="p p-Indicator">,</span><span class="nt"> maximum</span><span class="p">:</span> <span class="s">&quot;0.00&quot;</span><span class="p p-Indicator">,</span><span class="nt"> floatEncoding</span><span class="p">:</span> <span class="s">&quot;Base64&quot;</span> <span class="p p-Indicator">}</span>
    <span class="nt">units</span><span class="p">:</span>
      <span class="p p-Indicator">{</span><span class="nt"> type</span><span class="p">:</span> <span class="s">&quot;String&quot;</span><span class="p p-Indicator">,</span><span class="nt"> readWrite</span><span class="p">:</span> <span class="s">&quot;R&quot;</span><span class="p p-Indicator">,</span><span class="nt"> defaultValue</span><span class="p">:</span> <span class="s">&quot;&quot;</span> <span class="p p-Indicator">}</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">randfloat64</span>
  <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;device</span><span class="nv"> </span><span class="s">random</span><span class="nv"> </span><span class="s">number</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">e</span><span class="nv"> </span><span class="s">notion&quot;</span>
  <span class="nt">properties</span><span class="p">:</span>
    <span class="nt">value</span><span class="p">:</span>
      <span class="p p-Indicator">{</span><span class="nt"> type</span><span class="p">:</span> <span class="s">&quot;Float64&quot;</span><span class="p p-Indicator">,</span><span class="nt"> size</span><span class="p">:</span> <span class="s">&quot;4&quot;</span><span class="p p-Indicator">,</span><span class="nt"> readWrite</span><span class="p">:</span> <span class="s">&quot;R&quot;</span><span class="p p-Indicator">,</span><span class="nt"> defaultValue</span><span class="p">:</span> <span class="s">&quot;0.00&quot;</span><span class="p p-Indicator">,</span><span class="nt"> minimum</span><span class="p">:</span> <span class="s">&quot;100.00&quot;</span><span class="p p-Indicator">,</span><span class="nt"> maximum</span><span class="p">:</span> <span class="s">&quot;0.00&quot;</span><span class="p p-Indicator">,</span><span class="nt"> floatEncoding</span><span class="p">:</span> <span class="s">&quot;eNotation&quot;</span> <span class="p p-Indicator">}</span>
    <span class="nt">units</span><span class="p">:</span>
      <span class="p p-Indicator">{</span><span class="nt"> type</span><span class="p">:</span> <span class="s">&quot;String&quot;</span><span class="p p-Indicator">,</span><span class="nt"> readWrite</span><span class="p">:</span> <span class="s">&quot;R&quot;</span><span class="p p-Indicator">,</span><span class="nt"> defaultValue</span><span class="p">:</span> <span class="s">&quot;&quot;</span> <span class="p p-Indicator">}</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ping</span>
  <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;device</span><span class="nv"> </span><span class="s">awake&quot;</span>
  <span class="nt">properties</span><span class="p">:</span>
    <span class="nt">value</span><span class="p">:</span>
      <span class="p p-Indicator">{</span><span class="nt"> type</span><span class="p">:</span> <span class="s">&quot;String&quot;</span><span class="p p-Indicator">,</span><span class="nt"> size</span><span class="p">:</span> <span class="s">&quot;0&quot;</span><span class="p p-Indicator">,</span><span class="nt"> readWrite</span><span class="p">:</span> <span class="s">&quot;R&quot;</span><span class="p p-Indicator">,</span><span class="nt"> defaultValue</span><span class="p">:</span> <span class="s">&quot;oops&quot;</span> <span class="p p-Indicator">}</span>
    <span class="nt">units</span><span class="p">:</span>
      <span class="p p-Indicator">{</span><span class="nt"> type</span><span class="p">:</span> <span class="s">&quot;String&quot;</span><span class="p p-Indicator">,</span><span class="nt"> readWrite</span><span class="p">:</span> <span class="s">&quot;R&quot;</span><span class="p p-Indicator">,</span><span class="nt"> defaultValue</span><span class="p">:</span> <span class="s">&quot;&quot;</span> <span class="p p-Indicator">}</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">message</span>
  <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;device</span><span class="nv"> </span><span class="s">notification</span><span class="nv"> </span><span class="s">message&quot;</span>
  <span class="nt">properties</span><span class="p">:</span>
    <span class="nt">value</span><span class="p">:</span>
      <span class="p p-Indicator">{</span><span class="nt"> type</span><span class="p">:</span> <span class="s">&quot;String&quot;</span><span class="p p-Indicator">,</span><span class="nt"> size</span><span class="p">:</span> <span class="s">&quot;0&quot;</span><span class="p p-Indicator">,</span><span class="nt"> readWrite</span><span class="p">:</span> <span class="s">&quot;W&quot;</span> <span class="p p-Indicator">,</span><span class="nt">scale</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p p-Indicator">,</span><span class="nt"> offset</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p p-Indicator">,</span><span class="nt"> base</span><span class="p">:</span> <span class="s">&quot;&quot;</span>  <span class="p p-Indicator">}</span>
    <span class="nt">units</span><span class="p">:</span>
      <span class="p p-Indicator">{</span><span class="nt"> type</span><span class="p">:</span> <span class="s">&quot;String&quot;</span><span class="p p-Indicator">,</span><span class="nt"> readWrite</span><span class="p">:</span> <span class="s">&quot;R&quot;</span><span class="p p-Indicator">,</span><span class="nt"> defaultValue</span><span class="p">:</span> <span class="s">&quot;&quot;</span> <span class="p p-Indicator">}</span>

<span class="nt">deviceCommands</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testrandfloat32</span>
  <span class="nt">get</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nt"> index</span><span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p p-Indicator">,</span><span class="nt"> operation</span><span class="p">:</span> <span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="nt"> deviceResource</span><span class="p">:</span> <span class="s">&quot;randfloat32&quot;</span><span class="p p-Indicator">}</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testrandfloat64</span>
  <span class="nt">get</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nt"> index</span><span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p p-Indicator">,</span><span class="nt"> operation</span><span class="p">:</span> <span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="nt"> deviceResource</span><span class="p">:</span> <span class="s">&quot;randfloat64&quot;</span><span class="p p-Indicator">}</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testping</span>
  <span class="nt">get</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nt"> index</span><span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p p-Indicator">,</span><span class="nt"> operation</span><span class="p">:</span> <span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="nt"> deviceResource</span><span class="p">:</span> <span class="s">&quot;ping&quot;</span><span class="p p-Indicator">}</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testmessage</span>
  <span class="nt">get</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nt"> index</span><span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p p-Indicator">,</span><span class="nt"> operation</span><span class="p">:</span> <span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="nt"> deviceResource</span><span class="p">:</span> <span class="s">&quot;message&quot;</span><span class="p p-Indicator">}</span>
  <span class="nt">set</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nt"> index</span><span class="p">:</span> <span class="s">&quot;1&quot;</span><span class="p p-Indicator">,</span><span class="nt"> operation</span><span class="p">:</span> <span class="s">&quot;set&quot;</span><span class="p p-Indicator">,</span><span class="nt"> deviceResource</span><span class="p">:</span> <span class="s">&quot;message&quot;</span><span class="p p-Indicator">}</span>

<span class="nt">coreCommands</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testrandfloat32</span>
  <span class="nt">get</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="s">&quot;/api/v1/device/{deviceId}/testrandfloat32&quot;</span>
    <span class="nt">responses</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;200&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;get</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">random</span><span class="nv"> </span><span class="s">float32</span><span class="nv"> </span><span class="s">value&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;randfloat32&quot;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;500&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;internal</span><span class="nv"> </span><span class="s">server</span><span class="nv"> </span><span class="s">error&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testrandfloat64</span>
  <span class="nt">get</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="s">&quot;/api/v1/device/{deviceId}/testrandfloat64&quot;</span>
    <span class="nt">responses</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;200&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;get</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">random</span><span class="nv"> </span><span class="s">float64</span><span class="nv"> </span><span class="s">value&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;randfloat64&quot;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;500&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;internal</span><span class="nv"> </span><span class="s">server</span><span class="nv"> </span><span class="s">error&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testping</span>
  <span class="nt">get</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="s">&quot;/api/v1/device/{deviceId}/testping&quot;</span>
    <span class="nt">responses</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;200&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;ping</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">device&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;ping&quot;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;500&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;internal</span><span class="nv"> </span><span class="s">server</span><span class="nv"> </span><span class="s">error&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testmessage</span>
  <span class="nt">get</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="s">&quot;/api/v1/device/{deviceId}/testmessage&quot;</span>
    <span class="nt">responses</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;200&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;get</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">message&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;message&quot;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;500&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;internal</span><span class="nv"> </span><span class="s">server</span><span class="nv"> </span><span class="s">error&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
  <span class="nt">put</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="s">&quot;/api/v1/device/{deviceId}/testmessage&quot;</span>
    <span class="nt">parameterNames</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;message&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">responses</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;204&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;set</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">message.&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
    <span class="p p-Indicator">-</span> <span class="nt">code</span><span class="p">:</span> <span class="s">&quot;500&quot;</span>
      <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;internal</span><span class="nv"> </span><span class="s">server</span><span class="nv"> </span><span class="s">error&quot;</span>
      <span class="nt">expectedValues</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
</code></pre></div>
</td></tr></table>

<p>デバイスプロファイルは、デバイスと一対一ではなく、例えばデバイスのモデルごとにひとつ用意するイメージです 。</p>
<p>この例では、冒頭の 6 行でデバイスのモデルを定義しています。先ほど動作させたデバイス（のシミュレータ）は、Dell 製の MQTT-2 というモデルである、という想定で書かれています。</p>
<p>その後、大きく deviceResources、deviceCommands、coreCommands、の三つのセクションが続いています。</p>
<p>deviceResources セクションでは、デバイスが持っているリソースと、それが持つ値の意味を決めています。この例では、このデバイスにリソース randfloat64 があり、それは 0.00 から 100.00 の範囲の Float64 型の値を持つと定義されています。また、message リソースは String 型の値を持ち、他のリソースと違って書き換えが可能（W）と定義されていることがわかります。</p>
<p>deviceCommands セクションでは、このデバイスに対して実行できるコマンドを定義し、そのコマンドのメソッド（get または set）ごとに参照または操作されるリソースを紐付けています。例えば、testrandfloat64 コマンドの get メソッドは、先に deviecResources で定義したリソース randfloat64 からの値の読み取りを行えるように定義されています。また、testmessage コマンドでは、set または get メソッドにより、リソース message の値の取得や変更ができるように定義されています。なお、ここでは実装されていませんが、ひとつのメソッドに複数のリソースを紐付けることも可能です。つまり、一回の get 操作で複数のリソースの値を同時に取得するようにも構成できます。<a href="http://www.iotechsys.com/cmsfiles/iotech_systems/docs/edgexpert/device-services/Ch-DeviceProfiles.html">Edge Xpert のドキュメントでは、そのような例が解説され</a> ています。</p>
<p>coreCommands セクションでは、コアサービス層からデバイスに対して実行できるコマンドを定義しています。例えば、コアサービスが testrandfloat64 コマンドに GET リクエストを実行すると、その命令はパス /api/v1/device/{deviceId}/testrandfloat64 に渡されます。このパスは、先の deviceCommands で定義した testrandfloat64 コマンドを表すものです。そしてコアサービスは、結果としてレスポンスコード 200 が返ってきた場合は、そのレスポンスボディに含まれる値を randfloat32 の値として取り込むように構成されています。また、testmessage コマンドのみ、ほかのコマンドと異なり PUT リクエストの動作が定義されています。</p>
<h3 id="_10">デバイスサービス設定<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>今回は、configuration.toml を利用します。中身は以下の通りです。</p>
<p>このファイルは環境依存の固定値を含みます。自分の環境で試す場合は、IP アドレスを環境に合わせて書き換えてください。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ cat mqtt/configuration.toml
<span class="c1"># configuration.toml</span>
<span class="o">[</span>Writable<span class="o">]</span>
<span class="nv">LogLevel</span> <span class="o">=</span> <span class="s1">&#39;DEBUG&#39;</span>

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Host</span> <span class="o">=</span> <span class="s2">&quot;edgex-device-mqtt&quot;</span>
<span class="nv">Port</span> <span class="o">=</span> <span class="m">49982</span>
<span class="nv">ConnectRetries</span> <span class="o">=</span> <span class="m">3</span>
<span class="nv">Labels</span> <span class="o">=</span> <span class="o">[]</span>
<span class="nv">OpenMsg</span> <span class="o">=</span> <span class="s2">&quot;device mqtt started&quot;</span>
<span class="nv">Timeout</span> <span class="o">=</span> <span class="m">5000</span>
<span class="nv">EnableAsyncReadings</span> <span class="o">=</span> <span class="nb">true</span>
<span class="nv">AsyncBufferSize</span> <span class="o">=</span> <span class="m">16</span>

<span class="o">[</span>Registry<span class="o">]</span>
<span class="nv">Host</span> <span class="o">=</span> <span class="s2">&quot;edgex-core-consul&quot;</span>
<span class="nv">Port</span> <span class="o">=</span> <span class="m">8500</span>
<span class="nv">CheckInterval</span> <span class="o">=</span> <span class="s2">&quot;10s&quot;</span>
<span class="nv">FailLimit</span> <span class="o">=</span> <span class="m">3</span>
<span class="nv">FailWaitTime</span> <span class="o">=</span> <span class="m">10</span>
<span class="nv">Type</span> <span class="o">=</span> <span class="s2">&quot;consul&quot;</span>

<span class="o">[</span>Logging<span class="o">]</span>
<span class="nv">EnableRemote</span> <span class="o">=</span> <span class="nb">false</span>
<span class="nv">File</span> <span class="o">=</span> <span class="s2">&quot;./device-mqtt.log&quot;</span>

<span class="o">[</span>Clients<span class="o">]</span>
  <span class="o">[</span>Clients.Data<span class="o">]</span>
  <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&quot;edgex-core-data&quot;</span>
  <span class="nv">Protocol</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
  <span class="nv">Host</span> <span class="o">=</span> <span class="s2">&quot;edgex-core-data&quot;</span>
  <span class="nv">Port</span> <span class="o">=</span> <span class="m">48080</span>
  <span class="nv">Timeout</span> <span class="o">=</span> <span class="m">50000</span>

  <span class="o">[</span>Clients.Metadata<span class="o">]</span>
  <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&quot;edgex-core-metadata&quot;</span>
  <span class="nv">Protocol</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
  <span class="nv">Host</span> <span class="o">=</span> <span class="s2">&quot;edgex-core-metadata&quot;</span>
  <span class="nv">Port</span> <span class="o">=</span> <span class="m">48081</span>
  <span class="nv">Timeout</span> <span class="o">=</span> <span class="m">50000</span>

  <span class="o">[</span>Clients.Logging<span class="o">]</span>
  <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&quot;edgex-support-logging&quot;</span>
  <span class="nv">Protocol</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
  <span class="nv">Host</span> <span class="o">=</span><span class="s2">&quot;edgex-support-logging&quot;</span>
  <span class="nv">Port</span> <span class="o">=</span> <span class="m">48061</span>

<span class="o">[</span>Device<span class="o">]</span>
  <span class="nv">DataTransform</span> <span class="o">=</span> <span class="nb">true</span>
  <span class="nv">InitCmd</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="nv">InitCmdArgs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="nv">MaxCmdOps</span> <span class="o">=</span> <span class="m">128</span>
  <span class="nv">MaxCmdValueLen</span> <span class="o">=</span> <span class="m">256</span>
  <span class="nv">RemoveCmd</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="nv">RemoveCmdArgs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="nv">ProfilesDir</span> <span class="o">=</span> <span class="s2">&quot;/custom-config&quot;</span>

<span class="c1"># Pre-define Devices</span>
<span class="o">[[</span>DeviceList<span class="o">]]</span>
  <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&quot;MQ_DEVICE&quot;</span>
  <span class="nv">Profile</span> <span class="o">=</span> <span class="s2">&quot;Test.Device.MQTT.Profile&quot;</span>
  <span class="nv">Description</span> <span class="o">=</span> <span class="s2">&quot;General MQTT device&quot;</span>
  <span class="nv">Labels</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;MQTT&quot;</span><span class="o">]</span>
  <span class="o">[</span>DeviceList.Protocols<span class="o">]</span>
    <span class="o">[</span>DeviceList.Protocols.mqtt<span class="o">]</span>
       <span class="nv">Schema</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
       <span class="nv">Host</span> <span class="o">=</span> <span class="s2">&quot;192.168.0.100&quot;</span>
       <span class="nv">Port</span> <span class="o">=</span> <span class="s2">&quot;1883&quot;</span>
       <span class="nv">ClientId</span> <span class="o">=</span> <span class="s2">&quot;CommandPublisher&quot;</span>
       <span class="nv">User</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
       <span class="nv">Password</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
       <span class="nv">Topic</span> <span class="o">=</span> <span class="s2">&quot;CommandTopic&quot;</span>
  <span class="o">[[</span>DeviceList.AutoEvents<span class="o">]]</span>
    <span class="nv">Frequency</span> <span class="o">=</span> <span class="s2">&quot;30s&quot;</span>
    <span class="nv">OnChange</span> <span class="o">=</span> <span class="nb">false</span>
    <span class="nv">Resource</span> <span class="o">=</span> <span class="s2">&quot;testrandfloat64&quot;</span>

<span class="c1"># Driver configs</span>
<span class="o">[</span>Driver<span class="o">]</span>
<span class="nv">IncomingSchema</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
<span class="nv">IncomingHost</span> <span class="o">=</span> <span class="s2">&quot;192.168.0.100&quot;</span>
<span class="nv">IncomingPort</span> <span class="o">=</span> <span class="s2">&quot;1883&quot;</span>
<span class="nv">IncomingUser</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="nv">IncomingPassword</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="nv">IncomingQos</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
<span class="nv">IncomingKeepAlive</span> <span class="o">=</span> <span class="s2">&quot;3600&quot;</span>
<span class="nv">IncomingClientId</span> <span class="o">=</span> <span class="s2">&quot;IncomingDataSubscriber&quot;</span>
<span class="nv">IncomingTopic</span> <span class="o">=</span> <span class="s2">&quot;DataTopic&quot;</span>
<span class="nv">ResponseSchema</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
<span class="nv">ResponseHost</span> <span class="o">=</span> <span class="s2">&quot;192.168.0.100&quot;</span>
<span class="nv">ResponsePort</span> <span class="o">=</span> <span class="s2">&quot;1883&quot;</span>
<span class="nv">ResponseUser</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="nv">ResponsePassword</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="nv">ResponseQos</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
<span class="nv">ResponseKeepAlive</span> <span class="o">=</span> <span class="s2">&quot;3600&quot;</span>
<span class="nv">ResponseClientId</span> <span class="o">=</span> <span class="s2">&quot;CommandResponseSubscriber&quot;</span>
<span class="nv">ResponseTopic</span> <span class="o">=</span> <span class="s2">&quot;ResponseTopic&quot;</span>
</code></pre></div>
</td></tr></table>

<p>このファイルで、実際のデバイスを定義したり、必要なパラメータを指定したりします。</p>
<p>前半部分では EdgeX Foundry 内の他のサービスの情報などを指定しています。</p>
<p>実際のデバイスの定義は [[DeviceList]] の部分です。デバイスプロファイル Test.Device.MQTT.Profile に紐づけてデバイス MQ_DEVICE を定義しています。また、このデバイスに対するコマンドの実行に利用する MQTT ブローカも指定しています。</p>
<p>[[DeviceList.AutoEvents]] の部分では、デバイス側からは自動では配信されない値であった randfloat64 の値を定期的に取得するため、30 秒ごとに testrandfloat64 コマンドを実行するように設定しています。</p>
<p>[Driver] の部分では、デバイスサービスがデバイスから情報を受け取るために購読する MQTT ブローカやトピック名を設定しています。</p>
<p>なお、今回はこのファイルの中で実デバイスの定義もしてしまっていますが、デバイスはあとからも追加が可能です。また、このファイルはあくまで MQTT デバイスサービスの設定ファイルなので、利用したいデバイスサービスが違えば当然この設定ファイルで書くべき内容も変わります。</p>
<h3 id="edgex-foundry">デバイスサービスを含んだ EdgeX Foundry の起動<a class="headerlink" href="#edgex-foundry" title="Permanent link">&para;</a></h3>
<p>設定ファイルができたら、デバイスサービスを含む EdgeX Foundry を起動します。</p>
<p>今回は、Docker Compose ファイルに以下を足しています。これにより、 edgexfoundry/docker-device-mqtt-go イメージがコンテナとして実行され、今回用の設定ファイルが含まれる mqtt ディレクトリがコンテナにマウントさたうえで、起動時にはその中身を利用して EdgeX Foundry にデバイスサービスとデバイスが登録されます。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="nt">device-mqtt</span><span class="p">:</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">edgexfoundry/docker-device-mqtt-go:1.1.1</span>
  <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;49982:49982&quot;</span>
  <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">edgex-device-mqtt</span>
  <span class="nt">hostname</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">edgex-device-mqtt</span>
  <span class="nt">networks</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">edgex-network</span>
  <span class="nt">volumes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db-data:/data/db</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">log-data:/edgex/logs</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">consul-config:/consul/config</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">consul-data:/consul/data</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./mqtt:/custom-config</span>
  <span class="nt">depends_on</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">data</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">command</span>
  <span class="nt">entrypoint</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/device-mqtt</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--registry=consul://edgex-core-consul:8500</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--confdir=/custom-config</span>
</code></pre></div>
</td></tr></table>

<p>では、実際にこのファイルを利用して EdgeX Foundry を起動させます。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ docker-compose up -d
</code></pre></div>
</td></tr></table>

<h2 id="_11">動作確認<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>まずは、デバイスサービスやデバイスが正常に EdgeX Foundry に認識されているか確認し、その後、値の収集やコマンド操作を確認します。</p>
<h3 id="_12">登録状態の確認<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>以前のエントリで device-virtual の存在を確認した方法 で、今回はデバイスサービス edgex-device-mqtt とデバイス MQ_DEVICE が確認できれば、登録は成功しています。ラクなのは UI か CLI ですね。</p>
<p>また、これまで紹介しませんでしたが、EdgeX Foundry はマイクロサービス群の状態管理に <a href="https://www.consul.io/">HashiCorp の Consul</a> を利用しており、各サービスの起動状態や登録状態は、この Consul を通じても確認できます。</p>
<p><img alt="" src="../img/device-service-mqtt-consul.png" /></p>
<p>Consul の GUI には、http://192.168.0.100:8500/ でアクセスできます。</p>
<p>Consul の GUI
ここで、</p>
<ul>
<li>[Services] タブで edgex-device-mqtt が緑色である</li>
<li>[Key/Value] タブで edgex &gt; devices &gt; 1.0 に edgex-device-mqtt がある</li>
<li>[Key/Value] タブで edgex &gt; devices &gt; 1.0 &gt; edgex-device-mqtt &gt; DeviceList &gt; 0 &gt; Name が MQ_DEVICE である</li>
</ul>
<p>あたりが確認できれば、登録はできていると考えてよいでしょう。</p>
<h3 id="_13">デバイスから配信されている値の収集の確認<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>今回のデバイスは、センサ randfloat32 の値を 15 秒ごとに自動的に MQTT トピックに配信していました。デバイスサービスはこれを受け取れるように構成しましたので、EdgeX Foundry に取り込まれているはずです。</p>
<p>これも、以前のエントリで値を確認した方法 で確認できます。これもラクなのは GUI か CLI ですが、例えば、API で確認する場合は以下の通りです。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">$</span> <span class="err">curl</span> <span class="err">-s</span> <span class="err">http://localhost:</span><span class="mi">48080</span><span class="err">/api/v</span><span class="mi">1</span><span class="err">/reading/name/randfloat</span><span class="mi">32</span><span class="err">/</span><span class="mi">3</span> <span class="err">|</span> <span class="err">jq</span>
<span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;23fdac76-0870-4b9d-b653-561d8a7c0423&quot;</span><span class="p">,</span>
    <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="mi">1579707885029</span><span class="p">,</span>
    <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="mi">1579707885005379300</span><span class="p">,</span>
    <span class="nt">&quot;modified&quot;</span><span class="p">:</span> <span class="mi">1579707885029</span><span class="p">,</span>
    <span class="nt">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;MQ_DEVICE&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;randfloat32&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;QdpmZg==&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;5c086b1d-6b38-48c0-9aef-9b800f9c72ab&quot;</span><span class="p">,</span>
    <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="mi">1579707870018</span><span class="p">,</span>
    <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="mi">1579707870004742000</span><span class="p">,</span>
    <span class="nt">&quot;modified&quot;</span><span class="p">:</span> <span class="mi">1579707870018</span><span class="p">,</span>
    <span class="nt">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;MQ_DEVICE&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;randfloat32&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;QeGZmg==&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;de67c865-0406-408d-b238-d33de1fe1032&quot;</span><span class="p">,</span>
    <span class="nt">&quot;created&quot;</span><span class="p">:</span> <span class="mi">1579707855022</span><span class="p">,</span>
    <span class="nt">&quot;origin&quot;</span><span class="p">:</span> <span class="mi">1579707855011006200</span><span class="p">,</span>
    <span class="nt">&quot;modified&quot;</span><span class="p">:</span> <span class="mi">1579707855022</span><span class="p">,</span>
    <span class="nt">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;MQ_DEVICE&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;randfloat32&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Qd2Zmg==&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
</td></tr></table>

<p>時刻はエポックミリ秒（origin はエポックナノ秒）なので、変換すると 15 秒おきであることが確認できます。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ date -d <span class="s2">&quot;@1579707885.029&quot;</span>
Wed <span class="m">22</span> Jan <span class="m">2020</span> <span class="m">03</span>:44:45 PM UTC

$ date -d <span class="s2">&quot;@1579707870.018&quot;</span>
Wed <span class="m">22</span> Jan <span class="m">2020</span> <span class="m">03</span>:44:30 PM UTC

$ date -d <span class="s2">&quot;@1579707855.022&quot;</span>
Wed <span class="m">22</span> Jan <span class="m">2020</span> <span class="m">03</span>:44:15 PM UTC
</code></pre></div>
</td></tr></table>

<h3 id="_14">デバイスサービスの自動実行イベントの確認<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>randfloat64 の値は、自動では配信されなかったため、デバイスサービスの設定（configuration.toml）に [[DeviceList.AutoEvents]] を定義して、デバイスサービス側から 30 秒ごとに自動で収集させていました。</p>
<p>これもデータの蓄積を任意の方法で確認できます。例えば CLI で確認する場合は以下の通りです。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ edgex-cli reading list MQ_DEVICE -l <span class="m">10</span> <span class="p">|</span> grep randfloat64
5df1da1a-91db-41cf-99fa-962e87077395    randfloat64     MQ_DEVICE       <span class="m">1579709342806935600</span>     <span class="m">4</span>.924730e+00    <span class="m">15</span> seconds      <span class="m">15</span> seconds      <span class="m">50</span> years
7c33bb76-c9e9-4ef8-a410-80227e236d13    randfloat64     MQ_DEVICE       <span class="m">1579709312695223100</span>     <span class="m">3</span>.734020e+00    <span class="m">45</span> seconds      <span class="m">45</span> seconds      <span class="m">50</span> years
053987f1-5a89-4cc2-a433-03432caa9039    randfloat64     MQ_DEVICE       <span class="m">1579709282611878800</span>     <span class="m">9</span>.320210e+00    About a minute  About a minute  <span class="m">50</span> years
</code></pre></div>
</td></tr></table>

<p>これも変換すると 30 秒おきであることが確認できます。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ date -d <span class="s2">&quot;@1579709342.806935600&quot;</span>
Wed Jan <span class="m">22</span> <span class="m">16</span>:09:02 UTC <span class="m">2020</span>

$ date -d <span class="s2">&quot;@1579709312.695223100&quot;</span>
Wed Jan <span class="m">22</span> <span class="m">16</span>:08:32 UTC <span class="m">2020</span>

$ date -d <span class="s2">&quot;@1579709282.611878800&quot;</span>
Wed Jan <span class="m">22</span> <span class="m">16</span>:08:02 UTC <span class="m">2020</span>
</code></pre></div>
</td></tr></table>

<h3 id="_15">デバイスへのコマンド実行の確認<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>このデバイスは、リソース message の値は EdgeX Foundry から変更できるような仕様で、デバイスプロファイルでもそれに合わせて PUT リクエストの挙動を定義していました。</p>
<p>では、この操作ができることを確認します。</p>
<p>デバイスプロファイルで定義した各コマンドは、内部では REST エンドポイントでリクエストを待ち受けてており、そしてこの URL は、API 経由で確認できます。具体的には、デバイスを示すエンドポイントへの GET リクエストの結果に含まれます。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ curl -s http://localhost:48082/api/v1/device/name/MQ_DEVICE <span class="p">|</span> jq
...
  <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;77fccbb8-f33b-42d8-bf21-6d55cdde2068&quot;</span>,
  <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;MQ_DEVICE&quot;</span>,
...
  <span class="s2">&quot;commands&quot;</span>: <span class="o">[</span>
...
      <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;testmessage&quot;</span>,
...
      <span class="s2">&quot;get&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;path&quot;</span>: <span class="s2">&quot;/api/v1/device/{deviceId}/testmessage&quot;</span>,
...
        <span class="s2">&quot;url&quot;</span>: <span class="s2">&quot;http://edgex-core-command:48082/api/v1/device/77fccbb8-f33b-42d8-bf21-6d55cdde2068/command/4daa4148-7c0e-4cfd-81cc-b2b740bb4de4&quot;</span>
      <span class="o">}</span>,
      <span class="s2">&quot;put&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;path&quot;</span>: <span class="s2">&quot;/api/v1/device/{deviceId}/testmessage&quot;</span>,
...
        <span class="s2">&quot;url&quot;</span>: <span class="s2">&quot;http://edgex-core-command:48082/api/v1/device/77fccbb8-f33b-42d8-bf21-6d55cdde2068/command/4daa4148-7c0e-4cfd-81cc-b2b740bb4de4&quot;</span>,
...
</code></pre></div>
</td></tr></table>

<p>EdgeX Foundry がデバイスにコマンドを実行するときは、内部ではこの URL に対して GET なり PUT なりをリクエストするわけです。そしてデバイスサービスがそれを受け取って、設定したとおりに翻訳してデバイスへの操作が実行され応答が返ることになります。</p>
<p>ここでは実際に、確認できた URL にリクエストを投げます。外部からこの URL を直接叩くときは、ホスト名部分を環境に合わせて書き換えたうえで叩きます。今回であれば、次のような操作で現在値が確認できます。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ curl -s http://localhost:48082/api/v1/device/77fccbb8-f33b-42d8-bf21-6d55cdde2068/command/4daa4148-7c0e-4cfd-81cc-b2b740bb4de4 <span class="p">|</span> jq
<span class="o">{</span>
  <span class="s2">&quot;device&quot;</span>: <span class="s2">&quot;MQ_DEVICE&quot;</span>,
  <span class="s2">&quot;origin&quot;</span>: <span class="m">1579710432121478400</span>,
  <span class="s2">&quot;readings&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;origin&quot;</span>: <span class="m">1579710432109675800</span>,
      <span class="s2">&quot;device&quot;</span>: <span class="s2">&quot;MQ_DEVICE&quot;</span>,
      <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;message&quot;</span>,
      <span class="s2">&quot;value&quot;</span>: <span class="s2">&quot;test-message&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">&quot;EncodedEvent&quot;</span>: null
<span class="o">}</span>
</code></pre></div>
</td></tr></table>

<p>まだ何も変更していないので、初期値（mqtt-script.js で定義されている）が返ってきました。</p>
<p>では、変更の PUT を投げます。JSON をリクエストボディに含めて PUT します。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ curl -s -X PUT -d <span class="s1">&#39;{&quot;message&quot;:&quot;modified-message&quot;}&#39;</span> http://localhost:48082/api/v1/device/77fccbb8-f33b-42d8-bf21-6d55cdde2068/command/4daa4148-7c0e-4cfd-81cc-b2b740bb4de4
</code></pre></div>
</td></tr></table>

<p>エラーがなければ、再度 GET すると、値が変わっていることが確認できます。</p>
<p>ところで、URL は /api/v1/device/&lt;デバイス ID&gt;/command/&lt;コマンド ID&gt; なパスですが、実はわざわざ ID を調べなくても、/api/v1/device/name/&lt;デバイス名&gt;/command/&lt;コマンド名&gt; でも機能します。というわけで、お好みに合わせてどちらを使ってもよいですが、せっかくなので今度はこちらに GET します。</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ curl -s http://localhost:48082/api/v1/device/name/MQ_DEVICE/command/testmessage <span class="p">|</span> jq
<span class="o">{</span>
  <span class="s2">&quot;device&quot;</span>: <span class="s2">&quot;MQ_DEVICE&quot;</span>,
  <span class="s2">&quot;origin&quot;</span>: <span class="m">1579710963293832000</span>,
  <span class="s2">&quot;readings&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;origin&quot;</span>: <span class="m">1579710963283338200</span>,
      <span class="s2">&quot;device&quot;</span>: <span class="s2">&quot;MQ_DEVICE&quot;</span>,
      <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;message&quot;</span>,
      <span class="s2">&quot;value&quot;</span>: <span class="s2">&quot;modified-message&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">&quot;EncodedEvent&quot;</span>: null
<span class="o">}</span>
</code></pre></div>
</td></tr></table>

<p>値が変わっていることが確認できました。</p>
<p>なお、このような GET や PUT に相当する操作は、GUI でも実行できます。</p>
<p><img alt="" src="../img/device-service-mqtt-gui.png" /></p>
<h2 id="_16">まとめ<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h2>
<p>新しいデバイス（のシミュレータ）を用意し、それに合わせたデバイスサービスを構成して、このデバイスを EdgeX Foundry の制御下においたうえで、実際の動作を確認できました。</p>
<p>実際のシーンでは、本当のデバイスの本当の仕様に合わせてデバイスサービスを構成する必要があり、場合によってはデバイスサービスそれ自体の実装を含めてカスタマイズが必要になる可能性ももちろんあるわけです。</p>
<p>が、今回確認した通り、デバイスや環境に依存する部分（リソースやコマンドの名前や数、MQTT ブローカのホスト情報やトピック名など）は、デバイスプロファイルやデバイスサービス設定として別ファイルで定義できるようになっていて、デバイスサービスの実装それ自体は、設定ファイルに従って淡々と動くだけでもあります。</p>
<p>例えば Raspberry Pi に接続したセンサの値を取り込みたい場合を考えると、実際のセンサ値を MQTT トピックに投げる部分は自製する必要がありますが、であればその際に、逆に今回使ったこのデバイスサービスの仕様を前提にした投げ方にしてしまうことも可能です。そうすれば、このデバイスサービスをそのまま実際に流用できることになります。</p>
<p>今回は MQTT の例でしたが、それ以外のプロトコル用の参考実装も、環境依存の部分が設定ファイル群で外在化できるような汎用性のある形で作られているようなので、それなりに様々なデバイスで使いまわせそうです。</p>
<p>なお、EdgeX Foundry に取り込まれたデータは、前回のエントリで扱ったエクスポートの設定 や、アプリケーションサービスを構成することで、簡単に持ち出せます。コアサービス層に集約される段階で、すでにデバイスの差異は抽象化されているので、もちろん今回の MQTT で収集したデータも他のデバイスの情報とまったく同じ方法でエクスポート可能です。</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../lab2-gettingstarted/" title="Lab 2 - 導入とデータの確認" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前
                </span>
                Lab 2 - 導入とデータの確認
              </span>
            </div>
          </a>
        
        
          <a href="../lab4-appservice-export-mqtt/" title="Lab 4 - データのエクスポート（MQTT）" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  次
                </span>
                Lab 4 - データのエクスポート（MQTT）
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/kurokobo/" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/kurokobo/" target="_blank" rel="noopener" title="twitter" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
        
        
          
          <script src="../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
          
            
              
                <script src="../../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../../assets/javascripts/lunr/lunr.ja.js"></script>
              
            
          
          
            <script src="../../assets/javascripts/lunr/lunr.multi.js"></script>
          
        
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
    
  </body>
</html>